name: Build and Package

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  build:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            arch: x64
            node_arch: x64
            cmake_arch: x86_64
          
          # macOS builds
          - os: macos-latest
            arch: arm64
            node_arch: arm64
            cmake_arch: arm64
          
          # Windows builds with MSVC
          - os: windows-latest
            arch: x64
            node_arch: x64
            cmake_arch: x64

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node.js
        id: setup_node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          architecture: ${{ matrix.node_arch }}

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– - Linux
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            gfortran \
            libfftw3-dev \
            libboost-all-dev \
            pkg-config

      # 3a. Linux ARM64 äº¤å‰ç¼–è¯‘è®¾ç½®
      - name: Setup Linux ARM64 cross-compilation
        if: runner.os == 'Linux' && matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            gfortran-aarch64-linux-gnu
          # æ·»åŠ  ARM64 æž¶æž„æ”¯æŒ
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            libfftw3-dev:arm64 \
            libboost-all-dev:arm64
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡
          echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          echo "FC=aarch64-linux-gnu-gfortran" >> $GITHUB_ENV

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– - macOS
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake fftw boost gcc pkg-config
          
          # æ ¹æ®æž¶æž„è®¾ç½®ä¸åŒçš„è·¯å¾„
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # Apple Silicon (ARM64)
            BREW_PREFIX="/opt/homebrew"
          else
            # Intel (x64)
            BREW_PREFIX="/usr/local"
          fi
          
          # ç¡®ä¿brewè·¯å¾„åœ¨PATHä¸­
          echo "${BREW_PREFIX}/bin" >> $GITHUB_PATH
          
          # éªŒè¯gfortranå®‰è£…å¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "Checking gfortran installation..."
          ls -la ${BREW_PREFIX}/bin/gfortran* || echo "gfortran not found"
          
          # æ‰¾åˆ°æ­£ç¡®çš„gfortranè·¯å¾„å¹¶è®¾ç½®ä¸ºçŽ¯å¢ƒå˜é‡
          GFORTRAN_PATH=$(find ${BREW_PREFIX}/bin -name "gfortran*" | head -1)
          if [ -n "$GFORTRAN_PATH" ] && [ -x "$GFORTRAN_PATH" ]; then
            echo "Found gfortran at: $GFORTRAN_PATH"
            echo "FC=$GFORTRAN_PATH" >> $GITHUB_ENV
            echo "CMAKE_Fortran_COMPILER=$GFORTRAN_PATH" >> $GITHUB_ENV
            
            # æµ‹è¯•gfortran
            $GFORTRAN_PATH --version || echo "gfortran test failed"
          else
            echo "ERROR: gfortran not found or not executable"
            exit 1
          fi
          
          # è®¾ç½®åº“è·¯å¾„
          echo "LIBRARY_PATH=${BREW_PREFIX}/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${BREW_PREFIX}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      # 3. Windows MSVC çŽ¯å¢ƒè®¾ç½®
      - name: Setup Visual Studio Build Tools
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v1

      - name: Setup vcpkg & deps (Windows)
        if: runner.os == 'Windows'
        run: |
          set VCPKG_ROOT=%CD%\vcpkg
          git clone https://github.com/Microsoft/vcpkg.git %VCPKG_ROOT%
          %VCPKG_ROOT%\bootstrap-vcpkg.bat
          rem install floatâ€¯+â€¯threads variant so we get fftwf + multithread support
          %VCPKG_ROOT%\vcpkg install fftw3[float,threads]:x64-windows boost:x64-windows
          rem expose vcpkg-installed prefix to later cmake invocations
          echo VCPKG_ROOT=%VCPKG_ROOT%>>%GITHUB_ENV%
          echo CMAKE_PREFIX_PATH=%VCPKG_ROOT%\installed\x64-windows>>%GITHUB_ENV%
        shell: cmd

      - name: Strip node rc from PATH (Windows)
        if: runner.os == 'Windows'
        run: |
          rem Delete Nodeâ€‘wrapped rc scripts that mask the real RC compiler
          if exist "node_modules\.bin\rc" del /q node_modules\.bin\rc
          if exist "node_modules\.bin\rc.cmd" del /q node_modules\.bin\rc.cmd
          if exist "node_modules\.bin\rc.ps1" del /q node_modules\.bin\rc.ps1
          rem Cache the genuine Windows SDK rc.exe path for CMake
          for /f "delims=" %%v in ('dir "%ProgramFiles(x86)%\Windows Kits\10\bin" /b /ad ^| sort /r') do if not defined SDKVER set "SDKVER=%%v"
          echo CMAKE_RC_COMPILER=%ProgramFiles(x86)%\Windows Kits\10\bin\%SDKVER%\x64\rc.exe>>%GITHUB_ENV%
        shell: cmd

      - name: Setup Intel Fortran
        if: runner.os == 'Windows'
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: intel-classic
          version: '2021.10'

      - name: Verify Intel Fortran installation
        if: runner.os == 'Windows'
        run: |
          echo "=== Verifying Intel Fortran installation ==="
          echo "Checking for ifort..."
          where ifort || echo "ifort not found in PATH"
          echo "Checking for ifx..."
          where ifx || echo "ifx not found in PATH"
          
          echo "Setting up Intel oneAPI environment..."
          if exist "C:\Program Files (x86)\Intel\oneAPI\setvars.bat" (
            echo "Calling Intel oneAPI setvars.bat..."
            call "C:\Program Files (x86)\Intel\oneAPI\setvars.bat"
          ) else (
            echo "Intel oneAPI setvars.bat not found"
          )
          
          echo "Final check - Fortran compilers available:"
          where ifort && echo "âœ… ifort ready" || echo "âŒ ifort not available"
          where ifx && echo "âœ… ifx ready" || echo "âŒ ifx not available"
        shell: cmd

      # 4. å®‰è£… npm ä¾èµ–
      - name: Install npm dependencies
        run: npm ci --ignore-scripts

      # 5. æž„å»º TypeScript
      - name: Build TypeScript
        run: npm run build:ts

      # 6. æž„å»ºåŽŸç”Ÿæ¨¡å— - Linux/macOS
      - name: Build native module (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„CMakeç¼“å­˜
          rm -rf build/
          
          if [ "${{ matrix.arch }}" = "arm64" ] && [ "${{ runner.os }}" = "Linux" ]; then
            # Linux ARM64 äº¤å‰ç¼–è¯‘
            npx cmake-js compile --arch=${{ matrix.cmake_arch }} \
              --CDCMAKE_SYSTEM_NAME=Linux \
              --CDCMAKE_SYSTEM_PROCESSOR=aarch64 \
              --CDCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
              --CDCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
              --CDCMAKE_Fortran_COMPILER=aarch64-linux-gnu-gfortran
          else
            # æœ¬åœ°ç¼–è¯‘
            npx cmake-js compile --arch=${{ matrix.cmake_arch }}
          fi

      # 6. æž„å»ºåŽŸç”Ÿæ¨¡å— - Windows MSVC
      - name: Build native module (Windows MSVC)
        if: runner.os == 'Windows'
        run: |
          echo "--- Building with MSVC toolchain ---"
          
          echo "Setting up Intel Fortran environment..."
          if exist "C:\Program Files (x86)\Intel\oneAPI\setvars.bat" (
            echo "Calling Intel oneAPI setvars.bat..."
            call "C:\Program Files (x86)\Intel\oneAPI\setvars.bat"
          )
          
          echo "Setting up MSVC environment..."
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          echo "Verifying compilers after environment setup..."
          where cl && echo "MSVC cl available" || echo "MSVC cl not available"
          where ifort && echo "ifort available" || echo "ifort not available"
          where ifx && echo "ifx available" || echo "ifx not available"
          
          echo "Cleaning build directory..."
          rmdir /s /q build 2>nul || echo "No build directory to clean"
          
          echo "Starting cmake-js compilation with NMake..."
          set "IFORT_PATH=C:/Program Files (x86)/Intel/oneAPI/compiler/latest/windows/bin/intel64/ifort.exe"
          
          echo "Finding MSVC cl.exe..."
          for /f "delims=" %%i in ('where cl') do set "MSVC_CL_PATH=%%i"
          echo "Found MSVC cl.exe at: %MSVC_CL_PATH%"
          
          echo "Temporarily renaming Node.js rc to avoid conflicts..."
          if exist "node_modules\.bin\rc.exe" (
            ren "node_modules\.bin\rc.exe" "rc.exe.bak"
            echo "Renamed node_modules\.bin\rc.exe to rc.exe.bak"
          )
          if exist "node_modules\.bin\rc" (
            ren "node_modules\.bin\rc" "rc.bak"
            echo "Renamed node_modules\.bin\rc to rc.bak"
          )
          if exist "node_modules\.bin\rc.cmd" (
            ren "node_modules\.bin\rc.cmd" "rc.cmd.bak"
            echo "Renamed node_modules\.bin\rc.cmd to rc.cmd.bak"
          )
          if exist "node_modules\.bin\rc.ps1" (
            ren "node_modules\.bin\rc.ps1" "rc.ps1.bak"
            echo "Renamed node_modules\.bin\rc.ps1 to rc.ps1.bak"
          )
          
          npx cmake-js compile --arch=${{ matrix.cmake_arch }} ^
            -G "NMake Makefiles" ^
            --CDCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake ^
            --CDCMAKE_C_COMPILER="%MSVC_CL_PATH%" ^
            --CDCMAKE_CXX_COMPILER="%MSVC_CL_PATH%" ^
            --CDCMAKE_Fortran_COMPILER="%IFORT_PATH%" ^
            --verbose
          
          echo "Restoring Node.js rc tools..."
          if exist "node_modules\.bin\rc.exe.bak" (
            ren "node_modules\.bin\rc.exe.bak" "rc.exe"
            echo "Restored node_modules\.bin\rc.exe"
          )
          if exist "node_modules\.bin\rc.bak" (
            ren "node_modules\.bin\rc.bak" "rc"
            echo "Restored node_modules\.bin\rc"
          )
          if exist "node_modules\.bin\rc.cmd.bak" (
            ren "node_modules\.bin\rc.cmd.bak" "rc.cmd"
            echo "Restored node_modules\.bin\rc.cmd"
          )
          if exist "node_modules\.bin\rc.ps1.bak" (
            ren "node_modules\.bin\rc.ps1.bak" "rc.ps1"
            echo "Restored node_modules\.bin\rc.ps1"
          )
        shell: cmd

      # 7. è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: |
          # æ˜¾ç¤ºç¼–è¯‘åŽçš„æ–‡ä»¶ç»“æž„
          echo "ðŸ“ Checking compiled files structure:"
          ls -la dist/ || echo "dist directory not found"
          find dist -name "*.js" -type f || echo "No JS files found in dist"
          
          # æ£€æŸ¥æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "dist/test/wsjtx.basic.test.js" ]; then
            echo "âœ… Basic test file found: dist/test/wsjtx.basic.test.js"
            
            # æ£€æŸ¥åŽŸç”Ÿæ¨¡å—æ˜¯å¦å­˜åœ¨
            if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
              echo "âœ… Native module found: build/Release/wsjtx_lib_nodejs.node"
              # è¿è¡ŒåŸºç¡€æµ‹è¯•
              npm test
            else
              echo "âŒ Native module not found! Cannot run tests."
              exit 1
            fi
          else
            echo "âŒ Basic test file not found!"
            exit 1
          fi
        shell: bash

      # 8. åˆ›å»ºé¢„æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
      - name: Create prebuilt binaries
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p prebuilds/${{ matrix.os }}-${{ matrix.arch }}
          
          # å¤åˆ¶æž„å»ºçš„ .node æ–‡ä»¶
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp build/Release/*.node prebuilds/${{ matrix.os }}-${{ matrix.arch }}/
          else
            cp build/Release/*.node prebuilds/${{ matrix.os }}-${{ matrix.arch }}/
          fi
          
          # æ˜¾ç¤ºæž„å»ºç»“æžœ
          echo "æž„å»ºå®Œæˆçš„æ–‡ä»¶:"
          ls -la prebuilds/${{ matrix.os }}-${{ matrix.arch }}/
        shell: bash

      # 9. ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt-${{ matrix.os }}-${{ matrix.arch }}
          path: prebuilds/
          retention-days: 30
          if-no-files-found: error

      # 10. ä¸Šä¼ å®Œæ•´æž„å»ºç›®å½•ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
      - name: Upload build directory for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-${{ matrix.os }}-${{ matrix.arch }}
          path: build/
          retention-days: 7

  # æ±‡æ€»æ‰€æœ‰æž„å»ºäº§ç‰©
  collect-artifacts:
    name: Collect All Artifacts
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          mkdir -p final-prebuilds
          
          # åˆå¹¶æ‰€æœ‰é¢„æž„å»ºæ–‡ä»¶
          for artifact_dir in all-artifacts/prebuilt-*; do
            if [ -d "$artifact_dir" ]; then
              echo "å¤„ç† $artifact_dir"
              cp -r "$artifact_dir"/* final-prebuilds/
            fi
          done
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æžœ
          echo "æ‰€æœ‰å¹³å°çš„æž„å»ºäº§ç‰©:"
          find final-prebuilds -name "*.node" -exec ls -la {} \;
          
          # åˆ›å»ºæž„å»ºæ‘˜è¦
          echo "# æž„å»ºæ‘˜è¦" > build-summary.md
          echo "æž„å»ºæ—¶é—´: $(date)" >> build-summary.md
          echo "## æ”¯æŒçš„å¹³å°:" >> build-summary.md
          find final-prebuilds -name "*.node" | while read file; do
            platform=$(echo "$file" | cut -d'/' -f2)
            echo "- $platform" >> build-summary.md
          done

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-prebuilds
          path: |
            final-prebuilds/
            build-summary.md
          retention-days: 90