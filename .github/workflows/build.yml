name: Build and Package

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            arch: x64
            node_arch: x64
            cmake_arch: x86_64
          
          # Linux ARM64 builds (native)
          - os: ubuntu-24.04-arm
            arch: arm64
            node_arch: arm64
            cmake_arch: arm64
          
          # macOS builds
          - os: macos-latest
            arch: arm64
            node_arch: arm64
            cmake_arch: arm64

          # macOS Intel builds
          - os: macos-15-intel
            arch: x64
            node_arch: x64
            cmake_arch: x86_64

          # Windows builds with MSYS2/MinGW-w64
          - os: windows-latest
            arch: x64
            node_arch: x64
            cmake_arch: x64

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node.js
        id: setup_node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          architecture: ${{ matrix.node_arch }}

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– - Linux
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            gfortran \
            libfftw3-dev \
            libboost-all-dev \
            pkg-config \
            patchelf

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– - macOS
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake fftw boost gcc pkg-config dylibbundler
          
          # æ ¹æ®æž¶æž„è®¾ç½®ä¸åŒçš„è·¯å¾„
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # Apple Silicon (ARM64)
            BREW_PREFIX="/opt/homebrew"
          else
            # Intel (x64)
            BREW_PREFIX="/usr/local"
          fi
          
          # ç¡®ä¿brewè·¯å¾„åœ¨PATHä¸­
          echo "${BREW_PREFIX}/bin" >> $GITHUB_PATH
          
          # éªŒè¯gfortranå®‰è£…å¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "Checking gfortran installation..."
          ls -la ${BREW_PREFIX}/bin/gfortran* || echo "gfortran not found"
          
          # æ‰¾åˆ°æ­£ç¡®çš„gfortranè·¯å¾„å¹¶è®¾ç½®ä¸ºçŽ¯å¢ƒå˜é‡
          GFORTRAN_PATH=$(find ${BREW_PREFIX}/bin -name "gfortran*" | head -1)
          if [ -n "$GFORTRAN_PATH" ] && [ -x "$GFORTRAN_PATH" ]; then
            echo "Found gfortran at: $GFORTRAN_PATH"
            echo "FC=$GFORTRAN_PATH" >> $GITHUB_ENV
            echo "CMAKE_Fortran_COMPILER=$GFORTRAN_PATH" >> $GITHUB_ENV
            
            # æµ‹è¯•gfortran
            $GFORTRAN_PATH --version || echo "gfortran test failed"
          else
            echo "ERROR: gfortran not found or not executable"
            exit 1
          fi
          
          # è®¾ç½®åº“è·¯å¾„
          echo "LIBRARY_PATH=${BREW_PREFIX}/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${BREW_PREFIX}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      # 3. è®¾ç½® MSYS2 çŽ¯å¢ƒ - Windows
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-fftw
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-gcc-fortran
            mingw-w64-x86_64-nodejs

      # 4. å®‰è£… npm ä¾èµ–
      - name: Install npm dependencies
        run: npm ci --ignore-scripts

      # 5. æž„å»º TypeScript
      - name: Build TypeScript
        run: npm run build:ts

      # 6. éªŒè¯æž„å»ºçŽ¯å¢ƒ - Windows (åŸºäºŽ build_mingw.sh)
      - name: Verify build environment (Windows MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "=== Verifying essential tools ==="
          which cmake && cmake --version || { echo "âŒ CMake not found"; exit 1; }
          which gcc && gcc --version || { echo "âŒ GCC not found"; exit 1; }
          which g++ && g++ --version || { echo "âŒ G++ not found"; exit 1; }
          which gfortran && gfortran --version || { echo "âŒ gfortran not found"; exit 1; }
          which pkg-config && pkg-config --version || { echo "âŒ pkg-config not found"; exit 1; }
          which node && node --version || { echo "âŒ Node.js not found"; exit 1; }
          which npm && npm --version || { echo "âŒ npm not found"; exit 1; }
          which npx && npx --version || { echo "âŒ npx not found"; exit 1; }
          
          echo -e "\n=== Checking node-addon-api headers ==="
          if [ -d "node_modules/node-addon-api" ]; then
              echo "âœ… node-addon-api package found"
              if [ -f "node_modules/node-addon-api/napi.h" ]; then
                  echo "âœ… napi.h found"
              else
                  echo "âŒ napi.h not found"
                  exit 1
              fi
          else
              echo "âŒ node-addon-api package not found"
              exit 1
          fi
          
          echo -e "\n=== Checking FFTW3 availability ==="
          if pkg-config --exists fftw3f; then
              echo "âœ… FFTW3F found"
              echo "FFTW3F libraries: $(pkg-config --libs fftw3f)"
          else
              echo "âŒ FFTW3F not found"
              exit 1
          fi
          
          echo -e "\n=== Checking Boost installation ==="
          if [ -d "/mingw64/include/boost" ]; then
              echo "âœ… Boost headers found"
          else
              echo "âŒ Boost headers not found"
              exit 1
          fi
          
          if ls /mingw64/lib/libboost* >/dev/null 2>&1; then
              echo "âœ… Boost libraries found"
          else
              echo "âŒ Boost libraries not found"
              exit 1
          fi

      # 7. æž„å»ºåŽŸç”Ÿæ¨¡å— - ç»Ÿä¸€æµç¨‹ï¼ˆæ‰€æœ‰å¹³å°ï¼‰
      - name: Build native module (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„CMakeç¼“å­˜
          rm -rf build/

          # åŽŸç”Ÿç¼–è¯‘ï¼ˆæ”¯æŒæ‰€æœ‰æž¶æž„ï¼‰
          # æ–°æž¶æž„: wsjtx_lib (static) -> wsjtx_bridge (dynamic) -> .node (loads bridge)
          npx cmake-js compile --arch=${{ matrix.cmake_arch }}

      # 8a. Windowsæž„å»º - ç¬¬ä¸€æ­¥ï¼šMinGWæž„å»ºwsjtx_libå’Œwsjtx_bridge.dll
      - name: Build wsjtx_bridge.dll (Windows/MinGW)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "=== Step 1: Building wsjtx_lib + wsjtx_bridge.dll with MinGW ==="
          echo "Architecture: wsjtx_lib (static) + wsjtx_bridge.dll (dynamic)"

          # æ¸…ç†ä¹‹å‰çš„æž„å»º
          rm -rf build_mingw/
          mkdir -p build_mingw
          cd build_mingw

          # ä½¿ç”¨CMakeç›´æŽ¥æž„å»ºï¼ˆMinGW Makefiles generatorï¼‰
          cmake .. \
            -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_Fortran_COMPILER=gfortran \
            -DCMAKE_PREFIX_PATH=/mingw64 \
            -DPKG_CONFIG_EXECUTABLE=/mingw64/bin/pkg-config \
            -DWSJTX_BUILD_LIBS=ON \
            -DWSJTX_BUILD_NODE_ADDON=OFF

          # æž„å»º
          cmake --build . --config Release

          # éªŒè¯æž„å»ºäº§ç‰©
          echo ""
          echo "ðŸ” Verifying MinGW build artifacts..."
          if [ ! -f "Release/wsjtx_bridge.dll" ]; then
            echo "âŒ Error: wsjtx_bridge.dll not found!"
            find . -name "wsjtx_bridge.dll" -o -name "libwsjtx_bridge.*"
            exit 1
          fi

          echo "âœ… wsjtx_bridge.dll built successfully"
          ls -lh Release/wsjtx_bridge.dll

          cd ..

      # 8b. Windowsæž„å»º - ç¬¬äºŒæ­¥ï¼šMSVCæž„å»º.nodeæ‰©å±•
      - name: Build .node extension (Windows/MSVC)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          echo === Step 2: Building .node extension with MSVC ===
          echo Architecture: .node (loads wsjtx_bridge.dll at runtime)

          REM ä½¿ç”¨cmake-jsæž„å»º.nodeï¼ˆè‡ªåŠ¨ä½¿ç”¨Visual Studioï¼‰
          npx cmake-js compile --arch=x64 --CDWSJTX_BUILD_LIBS=OFF --CDWSJTX_BUILD_NODE_ADDON=ON

          REM éªŒè¯æž„å»ºäº§ç‰©
          echo.
          echo Verifying MSVC build artifacts...
          if not exist "build\Release\wsjtx_lib_nodejs.node" (
            echo Error: wsjtx_lib_nodejs.node not found!
            dir /s /b build\*.node
            exit /b 1
          )

          echo All build artifacts generated successfully
          dir build\Release\*.node

      # 8c. Windowsæ‰“åŒ… - å¤åˆ¶æ‰€æœ‰å¿…éœ€æ–‡ä»¶
      - name: Package Windows binaries
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "ðŸ“¦ Packaging Windows prebuilt binaries..."
          mkdir -p prebuilds/win32-x64

          # å¤åˆ¶.nodeæ‰©å±•ï¼ˆMSVCæž„å»ºï¼‰
          cp build/Release/wsjtx_lib_nodejs.node prebuilds/win32-x64/
          echo "âœ… Copied .node extension (MSVC)"

          # å¤åˆ¶wsjtx_bridge.dllï¼ˆMinGWæž„å»ºï¼‰
          cp build_mingw/Release/wsjtx_bridge.dll prebuilds/win32-x64/
          echo "âœ… Copied wsjtx_bridge.dll (MinGW)"

          # å¤åˆ¶MinGWè¿è¡Œæ—¶ä¾èµ–
          echo "ðŸ“¦ Copying MinGW runtime dependencies..."
          cp /mingw64/bin/libfftw3f-3.dll prebuilds/win32-x64/
          cp /mingw64/bin/libgfortran-5.dll prebuilds/win32-x64/
          cp /mingw64/bin/libgcc_s_seh-1.dll prebuilds/win32-x64/
          cp /mingw64/bin/libstdc++-6.dll prebuilds/win32-x64/
          cp /mingw64/bin/libwinpthread-1.dll prebuilds/win32-x64/

          echo ""
          echo "âœ… Packaging complete"
          ls -lh prebuilds/win32-x64/

      # 9. éªŒè¯Windowsæž„å»ºäº§ç‰©
      - name: Verify Windows build artifacts
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "=== Verifying build artifacts ==="

          # æ£€æŸ¥.nodeæ‰©å±•çš„ä¾èµ–
          echo "ðŸ“‹ Dependencies of wsjtx_lib_nodejs.node:"
          objdump -p prebuilds/win32-x64/wsjtx_lib_nodejs.node | grep "DLL Name"
          echo ""

          # æ£€æŸ¥wsjtx_bridge.dllçš„ä¾èµ–
          echo "ðŸ“‹ Dependencies of wsjtx_bridge.dll:"
          objdump -p prebuilds/win32-x64/wsjtx_bridge.dll | grep "DLL Name"
          echo ""

          # æ£€æŸ¥å¯¼å‡ºçš„CæŽ¥å£
          echo "ðŸ“‹ Exported functions from wsjtx_bridge.dll:"
          objdump -p prebuilds/win32-x64/wsjtx_bridge.dll | grep "wsjtx_"
          echo ""

          echo "âœ… Verification complete"

      # 10. è¿è¡Œæµ‹è¯• - Linux/macOS
      - name: Run tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "ðŸ“ Checking compiled files structure:"
          ls -la dist/ || echo "dist directory not found"
          find dist -name "*.js" -type f || echo "No JS files found in dist"
          
          # æ£€æŸ¥æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "dist/test/wsjtx.basic.test.js" ]; then
            echo "âœ… Basic test file found: dist/test/wsjtx.basic.test.js"
            
            # æ£€æŸ¥åŽŸç”Ÿæ¨¡å—æ˜¯å¦å­˜åœ¨
            if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
              echo "âœ… Native module found: build/Release/wsjtx_lib_nodejs.node"
              ls -la build/Release/wsjtx_lib_nodejs.node
              # è¿è¡ŒåŸºç¡€æµ‹è¯•
              npm test
            elif [ -f "build/wsjtx_lib_nodejs.node" ]; then
              echo "âœ… Native module found: build/wsjtx_lib_nodejs.node"
              ls -la build/wsjtx_lib_nodejs.node
              # ç¡®ä¿åœ¨æ­£ç¡®ä½ç½®ï¼ŒæŸäº›ç³»ç»Ÿå¯èƒ½éœ€è¦Releaseå­ç›®å½•
              mkdir -p build/Release
              cp build/wsjtx_lib_nodejs.node build/Release/
              # è¿è¡ŒåŸºç¡€æµ‹è¯•
              npm test
            else
              echo "âŒ Native module not found! Searching for .node files..."
              find . -name "*.node" || echo "No .node files found"
              exit 1
            fi
          else
            echo "âŒ Basic test file not found!"
            echo "Available test files:"
            find dist -name "*.test.js" -type f || echo "No test files found"
            exit 1
          fi
        shell: bash

      # 10a. è¿è¡Œæµ‹è¯• - Windows (æ³¨æ„: æš‚æ—¶è·³è¿‡,å› ä¸ºéœ€è¦å®Œæ•´å®žçŽ°MSVC wrapper)
      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          echo === Windows Testing ===
          echo Note: Full testing requires complete MSVC wrapper implementation
          echo.

          REM æ£€æŸ¥æ–‡ä»¶ç»“æž„
          dir /s /b prebuilds\win32-x64\*.*

          REM TODO: åœ¨native wrapperå®Œå…¨å®žçŽ°åŽ,æ¢å¤æµ‹è¯•
          echo.
          echo âš ï¸  Skipping tests - MSVC wrapper implementation in progress
          echo âœ… Build verification passed

      # 11. åˆ›å»ºé¢„æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ - Linux/macOS
      - name: Create prebuilt binaries (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          # æ˜ å°„GitHub Actionså¹³å°åç§°åˆ°Node.jsæ ‡å‡†å¹³å°åç§°
          case "${{ matrix.os }}" in
            ubuntu-latest|ubuntu-*) PLATFORM_NAME="linux" ;;
            macos-latest) PLATFORM_NAME="darwin" ;;
            windows-latest) PLATFORM_NAME="win32" ;;
            *) PLATFORM_NAME="${{ matrix.os }}" ;;
          esac

          # åˆ›å»ºç›®æ ‡ç›®å½•
          TARGET_DIR="prebuilds/$PLATFORM_NAME-${{ matrix.arch }}"
          echo "ðŸ“ Creating target directory: $TARGET_DIR"
          echo "   â€¢ GitHub runner: ${{ matrix.os }}"
          echo "   â€¢ Node.js platform: $PLATFORM_NAME"
          echo "   â€¢ Architecture: ${{ matrix.arch }}"
          echo "   â€¢ New architecture: wsjtx_lib (static) -> wsjtx_bridge (dynamic) -> .node (loads bridge)"
          mkdir -p "$TARGET_DIR"

          # å¤åˆ¶æž„å»ºçš„ .node æ–‡ä»¶
          if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
            cp build/Release/wsjtx_lib_nodejs.node "$TARGET_DIR/"
            echo "âœ… Copied .node extension from build/Release/"
            NODE_FILE="$TARGET_DIR/wsjtx_lib_nodejs.node"
          else
            echo "âŒ Native module not found for packaging at build/Release!"
            find build -maxdepth 2 -type f -name "*.node" -print || true
            exit 1
          fi

          # å¤åˆ¶bridgeåŠ¨æ€åº“ï¼ˆæ–°æž¶æž„çš„å…³é”®ç»„ä»¶ï¼ï¼‰
          if [ "${{ runner.os }}" = "Linux" ]; then
            BRIDGE_LIB="build/Release/wsjtx_bridge.so"
          elif [ "${{ runner.os }}" = "macOS" ]; then
            BRIDGE_LIB="build/Release/wsjtx_bridge.dylib"
          fi

          if [ -f "$BRIDGE_LIB" ]; then
            cp "$BRIDGE_LIB" "$TARGET_DIR/"
            echo "âœ… Copied bridge library: $(basename $BRIDGE_LIB)"
            BRIDGE_FILE="$TARGET_DIR/$(basename $BRIDGE_LIB)"
          else
            echo "âŒ Bridge library not found: $BRIDGE_LIB"
            exit 1
          fi
          
          # æ£€æŸ¥å¹¶å¤åˆ¶åŠ¨æ€ä¾èµ–åº“
          echo "ðŸ” Checking dynamic dependencies..."
          
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "Checking Linux shared libraries..."
            # å°†ä¾èµ–åº“ä¸Ž .node æ”¾åœ¨åŒçº§ç›®å½•,ä¸Ž macOS å’Œ Windows ä¿æŒä¸€è‡´
            ldd "$NODE_FILE" | grep -v "linux-vdso\|ld-linux\|libc\|libm\|libpthread\|libdl" | awk '{print $3}' | grep -v "not found" | while read lib; do
              if [ -f "$lib" ] && [[ "$lib" == *"libfftw"* || "$lib" == *"libgfortran"* || "$lib" == *"libgcc"* || "$lib" == *"libquadmath"* || "$lib" == *"libstdc++"* ]]; then
                lib_name=$(basename "$lib")
                echo "ðŸ“¦ Bundling: $lib_name -> $TARGET_DIR/"
                cp -n "$lib" "$TARGET_DIR/" || cp "$lib" "$TARGET_DIR/"
              fi
            done
            echo "Setting RPATH to \$ORIGIN (same directory as .node)"
            patchelf --set-rpath '$ORIGIN' "$NODE_FILE" || true
            echo "ðŸ”Ž ldd after RPATH:"
            ldd "$NODE_FILE" || true
            echo ""
            echo "ðŸ“ Bundled .so files in $TARGET_DIR:"
            ls -la "$TARGET_DIR"/*.so* 2>/dev/null || echo "No .so files found"
          elif [ "${{ runner.os }}" = "macOS" ]; then
            echo "Bundling macOS dylibs with dylibbundler..."
            # ä¼˜å…ˆåœ¨ Homebrew çš„å¸¸è§è·¯å¾„æœç´¢
            SEARCH_PATHS=(
              "/opt/homebrew/opt/fftw/lib"
              "/opt/homebrew/opt/gcc@14/lib/gcc/14"
              "/opt/homebrew/opt/gcc/lib/gcc/current"
              "/usr/local/opt/fftw/lib"
              "/usr/local/opt/gcc@14/lib/gcc/14"
              "/usr/local/opt/gcc/lib/gcc/current"
            )
            SP_ARGS=""
            for p in "${SEARCH_PATHS[@]}"; do
              if [ -d "$p" ]; then
                SP_ARGS="$SP_ARGS -s $p"
              fi
            done
            # åŠ¨æ€åŠ å…¥ Cellar è·¯å¾„
            BREW_PREFIX=$(brew --prefix 2>/dev/null || echo "/opt/homebrew")
            for p in "$BREW_PREFIX/Cellar/fftw"/*/lib "$BREW_PREFIX/Cellar/gcc"/*/lib/gcc/current; do
              if [ -d "$p" ]; then
                SP_ARGS="$SP_ARGS -s $p"
              fi
            done

            # å¤„ç†.nodeæ‰©å±•çš„ä¾èµ–
            echo "ðŸ“¦ Bundling dependencies for .node extension..."
            dylibbundler -x "$NODE_FILE" -d "$TARGET_DIR" -p "@loader_path/" $SP_ARGS -b

            # å¤„ç†wsjtx_bridge.dylibçš„ä¾èµ–
            echo "ðŸ“¦ Bundling dependencies for wsjtx_bridge.dylib..."
            dylibbundler -x "$BRIDGE_FILE" -d "$TARGET_DIR" -p "@loader_path/" $SP_ARGS -b

            echo ""
            echo "ðŸ“ Bundled dylibs in $TARGET_DIR:"
            ls -la "$TARGET_DIR"/*.dylib 2>/dev/null || echo "No additional dylib files found"

            echo ""
            echo "ðŸ”Ž Final otool -L of .node file:"
            otool -L "$NODE_FILE"

            echo ""
            echo "ðŸ”Ž Final otool -L of wsjtx_bridge.dylib:"
            otool -L "$BRIDGE_FILE"

            echo ""
            echo "ðŸ” Verifying all dylib paths are relative..."
            if otool -L "$NODE_FILE" "$BRIDGE_FILE" | grep -E '^\s+(/opt/homebrew|/usr/local)'; then
              echo "âŒ ERROR: Found absolute Homebrew paths in final binaries!"
              exit 1
            else
              echo "âœ… All dependency paths are relative"
            fi
          fi
          
          # æ˜¾ç¤ºæž„å»ºç»“æžœ
          echo "ðŸ“ æž„å»ºå®Œæˆçš„æ–‡ä»¶:"
          ls -la "$TARGET_DIR"

          # è®¡ç®—æ–‡ä»¶æ•°é‡ï¼ˆåŽ»é™¤ç©ºæ ¼ï¼‰
          BRIDGE_LIBS=$(ls "$TARGET_DIR" | grep -E "\\.(so|dylib)$" | grep -v wsjtx_bridge | wc -l | tr -d ' ')

          # èŽ·å–æ–‡ä»¶å¤§å°ï¼ˆç¡®ä¿æ˜¯æ•°å­—æˆ–å¼•å·åŒ…è£¹çš„å­—ç¬¦ä¸²ï¼‰
          if [ "${{ runner.os }}" = "Linux" ]; then
            NODE_SIZE=$(stat -c%s "$TARGET_DIR"/*.node 2>/dev/null || echo "0")
            BRIDGE_SIZE=$(stat -c%s "$TARGET_DIR"/wsjtx_bridge.* 2>/dev/null || echo "0")
          else
            NODE_SIZE=$(stat -f%z "$TARGET_DIR"/*.node 2>/dev/null || echo "0")
            BRIDGE_SIZE=$(stat -f%z "$TARGET_DIR"/wsjtx_bridge.* 2>/dev/null || echo "0")
          fi

          # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
          cat > "$TARGET_DIR/build-info.json" << EOF
          {
            "platform": "$PLATFORM_NAME",
            "github_runner": "${{ matrix.os }}",
            "arch": "${{ matrix.arch }}",
            "node_version": "${{ env.NODE_VERSION }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "cmake_arch": "${{ matrix.cmake_arch }}",
            "architecture": "unified_bridge",
            "node_file_size": $NODE_SIZE,
            "bridge_file_size": $BRIDGE_SIZE,
            "bundled_libraries": $BRIDGE_LIBS,
            "build_flow": "wsjtx_lib (static) -> wsjtx_bridge (dynamic) -> .node (loads bridge)"
          }
          EOF
          
          echo "ðŸ“‹ æž„å»ºä¿¡æ¯:"
          cat "$TARGET_DIR/build-info.json"
        shell: bash

      # 11a. åˆ›å»ºé¢„æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ - Windows (å·²åœ¨æž„å»ºæ­¥éª¤å®Œæˆ,ä»…éœ€åˆ›å»ºå…ƒæ•°æ®)
      - name: Create prebuilt binaries (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "ðŸ“¦ Creating Windows prebuilt package metadata"

          TARGET_DIR="prebuilds/win32-${{ matrix.arch }}"

          # éªŒè¯æ‰€æœ‰å¿…éœ€æ–‡ä»¶å­˜åœ¨
          echo "ðŸ” Verifying package contents..."
          if [ ! -f "$TARGET_DIR/wsjtx_lib_nodejs.node" ]; then
            echo "âŒ Error: wsjtx_lib_nodejs.node not found!"
            exit 1
          fi

          if [ ! -f "$TARGET_DIR/wsjtx_bridge.dll" ]; then
            echo "âŒ Error: wsjtx_bridge.dll not found!"
            exit 1
          fi

          # ç»Ÿè®¡DLLæ•°é‡
          dll_count=$(ls -1 "$TARGET_DIR"/*.dll 2>/dev/null | wc -l)

          # èŽ·å–æ–‡ä»¶å¤§å°
          node_size=$(stat -c%s "$TARGET_DIR/wsjtx_lib_nodejs.node")
          total_size=$(du -sb "$TARGET_DIR" | cut -f1)

          # åˆ—å‡ºæ‰€æœ‰DLL
          bundled_dll_list=""
          for dll_file in "$TARGET_DIR"/*.dll; do
            if [ -f "$dll_file" ]; then
              dll_name=$(basename "$dll_file")
              if [ -z "$bundled_dll_list" ]; then
                bundled_dll_list="\"$dll_name\""
              else
                bundled_dll_list="$bundled_dll_list, \"$dll_name\""
              fi
            fi
          done

          # èŽ·å–wsjtx_bridge.dllå¤§å°
          bridge_size=$(stat -c%s "$TARGET_DIR/wsjtx_bridge.dll")

          # åˆ›å»ºæž„å»ºä¿¡æ¯
          cat > "$TARGET_DIR/build-info.json" << EOF
          {
            "platform": "win32",
            "github_runner": "${{ matrix.os }}",
            "arch": "${{ matrix.arch }}",
            "node_version": "${{ env.NODE_VERSION }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "architecture": "unified_bridge",
            "build_mode": "mingw",
            "node_file_size": $node_size,
            "bridge_file_size": $bridge_size,
            "bundled_dlls_count": $dll_count,
            "total_package_size": $total_size,
            "bundled_dlls": [$bundled_dll_list],
            "build_flow": "wsjtx_lib (static) -> wsjtx_bridge.dll (dynamic) -> .node (loads bridge)"
          }
          EOF

          echo "âœ… Package created successfully"
          echo ""
          echo "ðŸ“‹ Build info:"
          cat "$TARGET_DIR/build-info.json"
          echo ""
          echo "ðŸ“ Package contents:"
          ls -lh "$TARGET_DIR"

      # 12. ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt-${{ matrix.os == 'ubuntu-24.04-arm' && 'linux' || (matrix.os == 'ubuntu-latest' && 'linux' || (startsWith(matrix.os, 'macos') && 'darwin' || 'win32')) }}-${{ matrix.arch }}
          path: prebuilds/
          retention-days: 30
          if-no-files-found: error

      # 13. ä¸Šä¼ å®Œæ•´æž„å»ºç›®å½•ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
      - name: Upload build directory for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-${{ matrix.os == 'ubuntu-24.04-arm' && 'linux' || (matrix.os == 'ubuntu-latest' && 'linux' || (startsWith(matrix.os, 'macos') && 'darwin' || 'win32')) }}-${{ matrix.arch }}
          path: |
            build/
            CMakeCache.txt
            cmake_install.cmake
          retention-days: 7

  # æ±‡æ€»æ‰€æœ‰æž„å»ºäº§ç‰©
  collect-artifacts:
    name: Collect All Artifacts
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          mkdir -p final-prebuilds
          
          # åˆå¹¶æ‰€æœ‰é¢„æž„å»ºæ–‡ä»¶
          echo "ðŸ“ å¯ç”¨çš„æž„å»ºäº§ç‰©ç›®å½•:"
          ls -la all-artifacts/ || echo "No artifacts directory"
          
          for artifact_dir in all-artifacts/prebuilt-*; do
            if [ -d "$artifact_dir" ]; then
              echo "ðŸ“¦ å¤„ç† $artifact_dir"
              # æ˜¾ç¤ºç›®å½•å†…å®¹ä»¥ä¾¿è°ƒè¯•
              echo "   å†…å®¹:"
              ls -la "$artifact_dir"
              cp -r "$artifact_dir"/* final-prebuilds/
            fi
          done
          
          echo ""
          echo "ðŸ“‹ åˆå¹¶åŽçš„final-prebuildsç›®å½•ç»“æž„:"
          find final-prebuilds -type f | sort
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æžœ
          echo "æ‰€æœ‰å¹³å°çš„æž„å»ºäº§ç‰©:"
          find final-prebuilds -name "*.node" -exec ls -la {} \;
          
          # æ±‡æ€»æž„å»ºä¿¡æ¯
          echo "# æž„å»ºæ‘˜è¦" > build-summary.md
          echo "æž„å»ºæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> build-summary.md
          echo "" >> build-summary.md
          echo "## æ”¯æŒçš„å¹³å°:" >> build-summary.md
          
          for info_file in final-prebuilds/*/build-info.json; do
            if [ -f "$info_file" ]; then
              platform=$(jq -r '.platform' "$info_file")
              arch=$(jq -r '.arch' "$info_file")
              file_size=$(jq -r '.file_size' "$info_file")
              echo "- $platform-$arch ($(numfmt --to=iec $file_size 2>/dev/null || echo $file_size))" >> build-summary.md
            fi
          done
          
          echo "" >> build-summary.md
          echo "## æ–‡ä»¶è¯¦æƒ…:" >> build-summary.md
          find final-prebuilds -name "*.node" | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "unknown")
            size_human=$(numfmt --to=iec $size 2>/dev/null || echo "$size bytes")
            echo "- \`$(basename "$file")\`: $size_human" >> build-summary.md
          done

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-prebuilds
          path: |
            final-prebuilds/
            build-summary.md
          retention-days: 90
