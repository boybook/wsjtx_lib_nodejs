name: Build and Package

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            arch: x64
            node_arch: x64
            cmake_arch: x86_64
          
          # Linux ARM64 builds (native)
          - os: ubuntu-24.04-arm
            arch: arm64
            node_arch: arm64
            cmake_arch: arm64
          
          # macOS builds
          - os: macos-latest
            arch: arm64
            node_arch: arm64
            cmake_arch: arm64

          # macOS Intel builds
          - os: macos-15-intel
            arch: x64
            node_arch: x64
            cmake_arch: x86_64

          # Windows builds with MSYS2/MinGW-w64
          - os: windows-latest
            arch: x64
            node_arch: x64
            cmake_arch: x64

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node.js
        id: setup_node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          architecture: ${{ matrix.node_arch }}

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– - Linux
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            gfortran \
            libfftw3-dev \
            libboost-all-dev \
            pkg-config \
            patchelf

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– - macOS
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake fftw boost gcc pkg-config dylibbundler
          
          # æ ¹æ®æž¶æž„è®¾ç½®ä¸åŒçš„è·¯å¾„
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # Apple Silicon (ARM64)
            BREW_PREFIX="/opt/homebrew"
          else
            # Intel (x64)
            BREW_PREFIX="/usr/local"
          fi
          
          # ç¡®ä¿brewè·¯å¾„åœ¨PATHä¸­
          echo "${BREW_PREFIX}/bin" >> $GITHUB_PATH
          
          # éªŒè¯gfortranå®‰è£…å¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "Checking gfortran installation..."
          ls -la ${BREW_PREFIX}/bin/gfortran* || echo "gfortran not found"
          
          # æ‰¾åˆ°æ­£ç¡®çš„gfortranè·¯å¾„å¹¶è®¾ç½®ä¸ºçŽ¯å¢ƒå˜é‡
          GFORTRAN_PATH=$(find ${BREW_PREFIX}/bin -name "gfortran*" | head -1)
          if [ -n "$GFORTRAN_PATH" ] && [ -x "$GFORTRAN_PATH" ]; then
            echo "Found gfortran at: $GFORTRAN_PATH"
            echo "FC=$GFORTRAN_PATH" >> $GITHUB_ENV
            echo "CMAKE_Fortran_COMPILER=$GFORTRAN_PATH" >> $GITHUB_ENV
            
            # æµ‹è¯•gfortran
            $GFORTRAN_PATH --version || echo "gfortran test failed"
          else
            echo "ERROR: gfortran not found or not executable"
            exit 1
          fi
          
          # è®¾ç½®åº“è·¯å¾„
          echo "LIBRARY_PATH=${BREW_PREFIX}/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${BREW_PREFIX}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      # 3. è®¾ç½® MSYS2 çŽ¯å¢ƒ - Windows
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-fftw
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-gcc-fortran
            mingw-w64-x86_64-nodejs

      # 4. å®‰è£… npm ä¾èµ–
      - name: Install npm dependencies
        run: npm ci --ignore-scripts

      # 5. æž„å»º TypeScript
      - name: Build TypeScript
        run: npm run build:ts

      # 6. éªŒè¯æž„å»ºçŽ¯å¢ƒ - Windows (åŸºäºŽ build_mingw.sh)
      - name: Verify build environment (Windows MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "=== Verifying essential tools ==="
          which cmake && cmake --version || { echo "âŒ CMake not found"; exit 1; }
          which gcc && gcc --version || { echo "âŒ GCC not found"; exit 1; }
          which g++ && g++ --version || { echo "âŒ G++ not found"; exit 1; }
          which gfortran && gfortran --version || { echo "âŒ gfortran not found"; exit 1; }
          which pkg-config && pkg-config --version || { echo "âŒ pkg-config not found"; exit 1; }
          which node && node --version || { echo "âŒ Node.js not found"; exit 1; }
          which npm && npm --version || { echo "âŒ npm not found"; exit 1; }
          which npx && npx --version || { echo "âŒ npx not found"; exit 1; }
          
          echo -e "\n=== Checking node-addon-api headers ==="
          if [ -d "node_modules/node-addon-api" ]; then
              echo "âœ… node-addon-api package found"
              if [ -f "node_modules/node-addon-api/napi.h" ]; then
                  echo "âœ… napi.h found"
              else
                  echo "âŒ napi.h not found"
                  exit 1
              fi
          else
              echo "âŒ node-addon-api package not found"
              exit 1
          fi
          
          echo -e "\n=== Checking FFTW3 availability ==="
          if pkg-config --exists fftw3f; then
              echo "âœ… FFTW3F found"
              echo "FFTW3F libraries: $(pkg-config --libs fftw3f)"
          else
              echo "âŒ FFTW3F not found"
              exit 1
          fi
          
          echo -e "\n=== Checking Boost installation ==="
          if [ -d "/mingw64/include/boost" ]; then
              echo "âœ… Boost headers found"
          else
              echo "âŒ Boost headers not found"
              exit 1
          fi
          
          if ls /mingw64/lib/libboost* >/dev/null 2>&1; then
              echo "âœ… Boost libraries found"
          else
              echo "âŒ Boost libraries not found"
              exit 1
          fi

      # 7. æž„å»ºåŽŸç”Ÿæ¨¡å— - Linux/macOS
      - name: Build native module (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„CMakeç¼“å­˜
          rm -rf build/
          
          # åŽŸç”Ÿç¼–è¯‘ï¼ˆæ”¯æŒæ‰€æœ‰æž¶æž„ï¼‰
          npx cmake-js compile --arch=${{ matrix.cmake_arch }}

      # 8. æž„å»ºåŽŸç”Ÿæ¨¡å— - Windows MSYS2/MinGW-w64 (åŸºäºŽ build_mingw.sh)
      - name: Build native module (Windows MSYS2)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "=== Building with MSYS2/MinGW-w64 toolchain ==="
          
          # è°ƒè¯•ï¼šæ£€æŸ¥å…³é”®DLLçš„å­˜åœ¨
          echo "ðŸ” Pre-build DLL availability check:"
          for dll in libfftw3f-3.dll libfftw3f_threads-3.dll libgfortran-5.dll libgcc_s_seh-1.dll libwinpthread-1.dll libstdc++-6.dll; do
            if [ -f "/mingw64/bin/$dll" ]; then
              echo "  âœ… $dll: $(stat -c%s /mingw64/bin/$dll) bytes"
            else
              echo "  âŒ $dll: NOT FOUND"
            fi
          done
          echo ""
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡å¼ºåˆ¶ä½¿ç”¨ MinGW å·¥å…·é“¾
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig"
          export CMAKE_PREFIX_PATH="/mingw64"
          export CC="gcc"
          export CXX="g++"
          export FC="gfortran"
          export CMAKE_MAKE_PROGRAM="mingw32-make"
          
          # ç¦ç”¨ Visual Studio æ£€æµ‹
          unset VSINSTALLDIR
          unset VCINSTALLDIR
          unset WindowsSDKDir
          unset VCPKG_ROOT
          
          echo -e "\n=== Environment variables ==="
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          echo "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH"
          echo "CC=$CC, CXX=$CXX, FC=$FC"
          
          # æ¸…ç†æž„å»ºç›®å½•
          rm -rf build/
          
          echo -e "\n=== Starting build process ==="
          npx cmake-js compile --arch=${{ matrix.cmake_arch }} \
            --generator="MinGW Makefiles" \
            --no-retry \
            --verbose

      # 10. è¿è¡Œæµ‹è¯• - Linux/macOS
      - name: Run tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "ðŸ“ Checking compiled files structure:"
          ls -la dist/ || echo "dist directory not found"
          find dist -name "*.js" -type f || echo "No JS files found in dist"
          
          # æ£€æŸ¥æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "dist/test/wsjtx.basic.test.js" ]; then
            echo "âœ… Basic test file found: dist/test/wsjtx.basic.test.js"
            
            # æ£€æŸ¥åŽŸç”Ÿæ¨¡å—æ˜¯å¦å­˜åœ¨
            if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
              echo "âœ… Native module found: build/Release/wsjtx_lib_nodejs.node"
              ls -la build/Release/wsjtx_lib_nodejs.node
              # è¿è¡ŒåŸºç¡€æµ‹è¯•
              npm test
            elif [ -f "build/wsjtx_lib_nodejs.node" ]; then
              echo "âœ… Native module found: build/wsjtx_lib_nodejs.node"
              ls -la build/wsjtx_lib_nodejs.node
              # ç¡®ä¿åœ¨æ­£ç¡®ä½ç½®ï¼ŒæŸäº›ç³»ç»Ÿå¯èƒ½éœ€è¦Releaseå­ç›®å½•
              mkdir -p build/Release
              cp build/wsjtx_lib_nodejs.node build/Release/
              # è¿è¡ŒåŸºç¡€æµ‹è¯•
              npm test
            else
              echo "âŒ Native module not found! Searching for .node files..."
              find . -name "*.node" || echo "No .node files found"
              exit 1
            fi
          else
            echo "âŒ Basic test file not found!"
            echo "Available test files:"
            find dist -name "*.test.js" -type f || echo "No test files found"
            exit 1
          fi
        shell: bash

      # 10a. è¿è¡Œæµ‹è¯• - Windows (MSYS2/MinGW)
      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "ðŸ“ Checking compiled files structure:"
          
          if [ -d "dist" ]; then
            find dist -name "*.js" -type f | head -10
          else
            echo "dist directory not found"
          fi
          
          # æ£€æŸ¥æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "dist/test/wsjtx.basic.test.js" ]; then
            echo "âœ… Basic test file found: dist/test/wsjtx.basic.test.js"
            
          # æ£€æŸ¥åŽŸç”Ÿæ¨¡å—æ˜¯å¦å­˜åœ¨ï¼ˆç»Ÿä¸€è¦æ±‚ build/Releaseï¼‰
          if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
            echo "âœ… Native module found: build/Release/wsjtx_lib_nodejs.node"
            ls -la build/Release/wsjtx_lib_nodejs.node

            # æ£€æŸ¥æ¨¡å—ä¾èµ–
            echo "ðŸ” Checking module dependencies..."
            if command -v ldd >/dev/null 2>&1; then
              ldd build/Release/wsjtx_lib_nodejs.node || echo "ldd failed, trying objdump"
            fi
            
            echo ""
            echo "ðŸ” Checking DLL dependencies with objdump:"
            objdump -p build/Release/wsjtx_lib_nodejs.node | grep "DLL Name" || echo "objdump failed"
              
              # æ£€æŸ¥å…³é”®åº“æ˜¯å¦åœ¨PATHä¸­å¯ç”¨
              echo ""
              echo "ðŸ” Checking library availability in MinGW environment:"
              echo "PATH directories with libraries:"
              echo $PATH | tr ':' '\n' | while read dir; do
                if [ -d "$dir" ] && ls "$dir"/*.dll >/dev/null 2>&1; then
                  echo "  ðŸ“ $dir"
                  ls "$dir"/libfftw* "$dir"/libgfortran* "$dir"/libgcc* 2>/dev/null | head -3 || true
                fi
              done
              
              # è®¾ç½®çŽ¯å¢ƒå˜é‡ä»¥ç¡®ä¿åº“èƒ½è¢«æ‰¾åˆ°
              echo ""
              echo "ðŸ”§ Setting up library paths for testing..."
              export PATH="/mingw64/bin:$PATH"
              export LD_LIBRARY_PATH="/mingw64/lib:$LD_LIBRARY_PATH"
              
              echo "Updated PATH (first few entries):"
              echo $PATH | tr ':' '\n' | head -3
              
              # éªŒè¯Node.jsç‰ˆæœ¬å…¼å®¹æ€§
              echo ""
              echo "ðŸ” Verifying Node.js environment:"
              echo "MinGW Node.js version:"
              which node && node --version || echo "Node.js not found in MinGW PATH"
              
              # å¼ºåˆ¶ä½¿ç”¨GitHub Actionså®‰è£…çš„Node.jsç‰ˆæœ¬ï¼ˆä¸Žæž„å»ºæ—¶ä¸€è‡´ï¼‰
              echo ""
              echo "ðŸ”§ Ensuring Node.js version consistency..."
              echo "Expected Node.js version: ${{ env.NODE_VERSION }}"
              
              # æŸ¥æ‰¾GitHub Actionså®‰è£…çš„Node.jsè·¯å¾„
              GITHUB_NODE_PATH=""
              if [ -f "/c/hostedtoolcache/node/${{ env.NODE_VERSION }}"*/x64/node.exe ]; then
                GITHUB_NODE_PATH=$(dirname $(find /c/hostedtoolcache/node -name "node.exe" | grep "${{ env.NODE_VERSION }}" | head -1))
                echo "Found GitHub Actions Node.js at: $GITHUB_NODE_PATH"
              elif [ -f "/c/Program Files/nodejs/node.exe" ]; then
                GITHUB_NODE_PATH="/c/Program Files/nodejs"
                echo "Using system Node.js at: $GITHUB_NODE_PATH"
              fi
              
              # è®¾ç½®PATHï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Node.jsç‰ˆæœ¬ï¼Œä½†ä¿æŒMinGWåº“è·¯å¾„
              if [ -n "$GITHUB_NODE_PATH" ]; then
                export PATH="$GITHUB_NODE_PATH:/mingw64/bin:$PATH"
                echo "Updated PATH to use GitHub Actions Node.js"
                echo "Active Node.js version: $(node --version)"
                echo "Active npm version: $(npm --version)"
              else
                echo "âš ï¸ Warning: Could not find GitHub Actions Node.js, using MinGW Node.js"
                echo "This may cause version mismatch issues"
              fi
              
              # è¿è¡Œæµ‹è¯•
              echo ""
              echo "ðŸ§ª Running tests with version-matched Node.js..."
              npm test
              test_result=$?
              
              if [ $test_result -eq 0 ]; then
                echo "âœ… Tests passed!"
              else
                echo "âŒ Test failed with exit code: $test_result"
                
                # å°è¯•ç›´æŽ¥åŠ è½½æ¨¡å—
                echo "ðŸ” Trying to load module directly..."
                node -e "try { require('./build/Release/wsjtx_lib_nodejs.node'); console.log('âœ… Module loaded successfully'); } catch(e) { console.error('âŒ Load error:', e.message); console.error('   Code:', e.code); }"
                
                exit $test_result
              fi
              
            else
              echo "âŒ Native module not found! Searching for .node files..."
              find . -name "*.node" -type f || echo "No .node files found"
              exit 1
            fi
          else
            echo "âŒ Basic test file not found!"
            echo "Available test files:"
            find dist -name "*.test.js" -type f || echo "No test files found"
            exit 1
          fi

      # 11. åˆ›å»ºé¢„æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ - Linux/macOS
      - name: Create prebuilt binaries (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          # æ˜ å°„GitHub Actionså¹³å°åç§°åˆ°Node.jsæ ‡å‡†å¹³å°åç§°
          case "${{ matrix.os }}" in
            ubuntu-latest|ubuntu-*) PLATFORM_NAME="linux" ;;
            macos-latest) PLATFORM_NAME="darwin" ;;
            windows-latest) PLATFORM_NAME="win32" ;;
            *) PLATFORM_NAME="${{ matrix.os }}" ;;
          esac
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          TARGET_DIR="prebuilds/$PLATFORM_NAME-${{ matrix.arch }}"
          echo "ðŸ“ Creating target directory: $TARGET_DIR"
          echo "   â€¢ GitHub runner: ${{ matrix.os }}"  
          echo "   â€¢ Node.js platform: $PLATFORM_NAME"
          echo "   â€¢ Architecture: ${{ matrix.arch }}"
          mkdir -p "$TARGET_DIR"
          
          # å¤åˆ¶æž„å»ºçš„ .node æ–‡ä»¶ï¼ˆç»Ÿä¸€æ¥è‡ª build/Releaseï¼‰
          if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
            cp build/Release/wsjtx_lib_nodejs.node "$TARGET_DIR/"
            echo "Copied from build/Release/"
            # é‡è¦: NODE_FILE å¿…é¡»æŒ‡å‘ç›®æ ‡ç›®å½•ä¸­çš„æ–‡ä»¶,è¿™æ · dylibbundler æ‰ä¼šä¿®æ”¹æ­£ç¡®çš„æ–‡ä»¶
            NODE_FILE="$TARGET_DIR/wsjtx_lib_nodejs.node"
          else
            echo "âŒ Native module not found for packaging at build/Release!"
            echo "å½“å‰ build ç›®å½•ç»“æž„ï¼š"
            find build -maxdepth 2 -type f -name "*.node" -print || true
            exit 1
          fi
          
          # æ£€æŸ¥å¹¶å¤åˆ¶åŠ¨æ€ä¾èµ–åº“
          echo "ðŸ” Checking dynamic dependencies..."
          
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "Checking Linux shared libraries..."
            # å°†ä¾èµ–åº“ä¸Ž .node æ”¾åœ¨åŒçº§ç›®å½•,ä¸Ž macOS å’Œ Windows ä¿æŒä¸€è‡´
            ldd "$NODE_FILE" | grep -v "linux-vdso\|ld-linux\|libc\|libm\|libpthread\|libdl" | awk '{print $3}' | grep -v "not found" | while read lib; do
              if [ -f "$lib" ] && [[ "$lib" == *"libfftw"* || "$lib" == *"libgfortran"* || "$lib" == *"libgcc"* || "$lib" == *"libquadmath"* || "$lib" == *"libstdc++"* ]]; then
                lib_name=$(basename "$lib")
                echo "ðŸ“¦ Bundling: $lib_name -> $TARGET_DIR/"
                cp -n "$lib" "$TARGET_DIR/" || cp "$lib" "$TARGET_DIR/"
              fi
            done
            echo "Setting RPATH to \$ORIGIN (same directory as .node)"
            patchelf --set-rpath '$ORIGIN' "$NODE_FILE" || true
            echo "ðŸ”Ž ldd after RPATH:"
            ldd "$NODE_FILE" || true
            echo ""
            echo "ðŸ“ Bundled .so files in $TARGET_DIR:"
            ls -la "$TARGET_DIR"/*.so* 2>/dev/null || echo "No .so files found"
          elif [ "${{ runner.os }}" = "macOS" ]; then
            echo "Bundling macOS dylibs with dylibbundler..."
            # ä¼˜å…ˆåœ¨ Homebrew çš„å¸¸è§è·¯å¾„æœç´¢
            SEARCH_PATHS=(
              "/opt/homebrew/opt/fftw/lib"
              "/opt/homebrew/opt/gcc@14/lib/gcc/14"
              "/opt/homebrew/opt/gcc/lib/gcc/current"
              "/usr/local/opt/fftw/lib"
              "/usr/local/opt/gcc@14/lib/gcc/14"
              "/usr/local/opt/gcc/lib/gcc/current"
            )
            SP_ARGS=""
            for p in "${SEARCH_PATHS[@]}"; do
              if [ -d "$p" ]; then
                SP_ARGS="$SP_ARGS -s $p"
              fi
            done
            # åŠ¨æ€åŠ å…¥ Cellar è·¯å¾„ï¼Œé¿å…æŸäº›çŽ¯å¢ƒä¸‹æ‰¾ä¸åˆ°å®žé™…æ–‡ä»¶
            BREW_PREFIX=$(brew --prefix 2>/dev/null || echo "/opt/homebrew")
            for p in "$BREW_PREFIX/Cellar/fftw"/*/lib "$BREW_PREFIX/Cellar/gcc"/*/lib/gcc/current; do
              if [ -d "$p" ]; then
                SP_ARGS="$SP_ARGS -s $p"
              fi
            done

            # å°†ä¾èµ–åº“ä¸Ž .node æ”¾åœ¨åŒçº§ç›®å½•,é¿å…åµŒå¥—è·¯å¾„é—®é¢˜
            # æ³¨æ„: -od ä¼šæ¸…ç©ºç›®æ ‡ç›®å½•,ä½† .node å·²ç»å¤åˆ¶åˆ° TARGET_DIR,dylibbundler ä¸ä¼šåˆ é™¤å®ƒ
            # ä½¿ç”¨ -b å¯ç”¨å®žé™…å¤åˆ¶
            dylibbundler -x "$NODE_FILE" -d "$TARGET_DIR" -p "@loader_path/" $SP_ARGS -b

            echo ""
            echo "ðŸ“ Bundled dylibs in $TARGET_DIR:"
            ls -la "$TARGET_DIR"/*.dylib 2>/dev/null || echo "No dylib files found"

            echo ""
            echo "ðŸ”Ž Final otool -L of packaged .node file ($NODE_FILE):"
            otool -L "$NODE_FILE"

            echo ""
            echo "ðŸ” Verifying all dylib paths are relative:"
            if otool -L "$NODE_FILE" | grep -E '^\s+(/opt/homebrew|/usr/local)'; then
              echo "âŒ ERROR: Found absolute Homebrew paths in final binary!"
              exit 1
            else
              echo "âœ… All dependency paths are relative"
            fi
          fi
          
          # æ˜¾ç¤ºæž„å»ºç»“æžœ
          echo "ðŸ“ æž„å»ºå®Œæˆçš„æ–‡ä»¶:"
          ls -la "$TARGET_DIR"
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
          cat > "$TARGET_DIR/build-info.json" << EOF
          {
            "platform": "$PLATFORM_NAME",
            "github_runner": "${{ matrix.os }}",
            "arch": "${{ matrix.arch }}",
            "node_version": "${{ env.NODE_VERSION }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "cmake_arch": "${{ matrix.cmake_arch }}",
            "file_size": $(stat -c%s "$TARGET_DIR"/*.node 2>/dev/null || stat -f%z "$TARGET_DIR"/*.node 2>/dev/null || echo "unknown"),
            "bundled_libraries": $(ls "$TARGET_DIR" | grep -E "\\.(so|dylib)$" | wc -l)
          }
          EOF
          
          echo "ðŸ“‹ æž„å»ºä¿¡æ¯:"
          cat "$TARGET_DIR/build-info.json"
        shell: bash

      # 11a. åˆ›å»ºé¢„æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ - Windows (MSYS2)
      - name: Create prebuilt binaries (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          echo "ðŸ”§ Windows prebuilt packaging started"
          echo "Environment info:"
          echo "  â€¢ Shell: $0"
          echo "  â€¢ PWD: $(pwd)"
          echo "  â€¢ User: $(whoami)"
          echo ""
          
          # æ˜ å°„GitHub Actionså¹³å°åç§°åˆ°Node.jsæ ‡å‡†å¹³å°åç§°
          case "${{ matrix.os }}" in
            ubuntu-latest|ubuntu-*) PLATFORM_NAME="linux" ;;
            macos-latest) PLATFORM_NAME="darwin" ;;
            windows-latest) PLATFORM_NAME="win32" ;;
            *) PLATFORM_NAME="${{ matrix.os }}" ;;
          esac
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          TARGET_DIR="prebuilds/$PLATFORM_NAME-${{ matrix.arch }}"
          echo "ðŸ“ Creating target directory: $TARGET_DIR"
          echo "   â€¢ GitHub runner: ${{ matrix.os }}"
          echo "   â€¢ Node.js platform: $PLATFORM_NAME"
          echo "   â€¢ Architecture: ${{ matrix.arch }}"
          mkdir -p "$TARGET_DIR"
          
          # å¤åˆ¶æž„å»ºçš„ .node æ–‡ä»¶ - æ£€æŸ¥ä¸¤ä¸ªå¯èƒ½çš„ä½ç½®
          if [ -f "build/Release/wsjtx_lib_nodejs.node" ]; then
            cp build/Release/wsjtx_lib_nodejs.node "$TARGET_DIR/"
            echo "âœ… Copied from build/Release/"
            NODE_FILE="build/Release/wsjtx_lib_nodejs.node"
          elif [ -f "build/wsjtx_lib_nodejs.node" ]; then
            cp build/wsjtx_lib_nodejs.node "$TARGET_DIR/"
            echo "âœ… Copied from build/"
            NODE_FILE="build/wsjtx_lib_nodejs.node"
          else
            echo "âŒ Native module not found for packaging!"
            exit 1
          fi
          
          # æ£€æŸ¥å¹¶å¤åˆ¶å¿…è¦çš„DLLä¾èµ–
          echo "ðŸ” Analyzing DLL dependencies..."
          
          # èŽ·å–DLLä¾èµ–åˆ—è¡¨
          REQUIRED_DLLS=$(objdump -p "$NODE_FILE" | grep "DLL Name" | awk '{print $3}' | grep -E "(libfftw|libgfortran|libgcc|libwinpthread|libstdc)")
          
          echo "ðŸ“¦ Required DLLs to bundle:"
          for dll in $REQUIRED_DLLS; do
            echo "  - $dll"
          done
          
          # ä»ŽMinGWå¤åˆ¶å¿…è¦çš„DLLï¼ˆWindows ä¸ä½¿ç”¨å­ç›®å½•ï¼Œéœ€ä¸Ž .node åŒçº§ï¼‰
          echo ""
          echo "ðŸ“‹ Copying DLLs from MinGW..."
          bundled_count=0
          missing_dlls=""
          
          # é¦–å…ˆæ£€æŸ¥MinGWç›®å½•æ˜¯å¦å­˜åœ¨
          echo "ðŸ” Checking MinGW directory..."
          if [ -d "/mingw64/bin" ]; then
            echo "  âœ… /mingw64/bin exists"
            echo "  Available DLLs in /mingw64/bin:"
            ls /mingw64/bin/lib*.dll | head -10 || echo "  No lib*.dll files found"
          else
            echo "  âŒ /mingw64/bin not found!"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“‹ Processing each required DLL..."
          for dll in $REQUIRED_DLLS; do
            echo "  ðŸ” Checking: $dll"
            if [ -f "/mingw64/bin/$dll" ]; then
              if cp "/mingw64/bin/$dll" "$TARGET_DIR/" 2>/dev/null; then
                echo "    âœ… Bundled: $dll"
                bundled_count=$((bundled_count + 1))
              else
                echo "    âŒ Copy failed: $dll"
                missing_dlls="$missing_dlls $dll"
              fi
            else
              echo "    âŒ Missing: $dll"
              missing_dlls="$missing_dlls $dll"
              
              # å°è¯•æŸ¥æ‰¾ç±»ä¼¼åç§°çš„æ–‡ä»¶
              echo "    ðŸ” Looking for similar files..."
              find /mingw64/bin -name "*${dll%%-*}*" -type f | head -3 || echo "    No similar files found"
            fi
          done
          
          # æŠ¥å‘Šç»“æžœ
          echo ""
          echo "ðŸ“Š DLL bundling summary:"
          echo "  â€¢ Successfully bundled: $bundled_count DLLs"
          if [ -n "$missing_dlls" ]; then
            echo "  â€¢ Missing DLLs:$missing_dlls"
            echo "  âš ï¸  Some DLLs are missing, but continuing..."
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æžœ
          echo ""
          echo "ðŸ“ Final package contents:"
          ls -la "$TARGET_DIR"
          
          # èŽ·å–æ–‡ä»¶å¤§å°
          node_size=$(stat -c%s "$TARGET_DIR"/*.node)
          total_size=$(du -sb "$TARGET_DIR" | cut -f1)
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
          # èŽ·å–å®žé™…æ†ç»‘çš„DLLåˆ—è¡¨
          bundled_dll_list=""
          for dll_file in "$TARGET_DIR"/*.dll; do
            if [ -f "$dll_file" ]; then
              dll_name=$(basename "$dll_file")
              if [ -z "$bundled_dll_list" ]; then
                bundled_dll_list="\"$dll_name\""
              else
                bundled_dll_list="$bundled_dll_list, \"$dll_name\""
              fi
            fi
          done
          
          cat > "$TARGET_DIR/build-info.json" << EOF
          {
            "platform": "$PLATFORM_NAME",
            "github_runner": "${{ matrix.os }}",
            "arch": "${{ matrix.arch }}",
            "node_version": "${{ env.NODE_VERSION }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "cmake_arch": "${{ matrix.cmake_arch }}",
            "file_size": $node_size,
            "bundled_libraries": $bundled_count,
            "total_package_size": $total_size,
            "required_dlls": [$(echo "$REQUIRED_DLLS" | sed 's/^/"/;s/$/"/' | paste -sd, -)],
            "bundled_dlls": [$bundled_dll_list],
            "missing_dlls": "$(echo $missing_dlls | sed 's/^ *//' | sed 's/ *$//')"
          }
          EOF
          
          echo ""
          echo "ðŸ“‹ æž„å»ºä¿¡æ¯:"
          cat "$TARGET_DIR/build-info.json"
          
          echo ""
          echo "ðŸ“Š Package summary:"
          echo "  â€¢ Native module: $(basename $NODE_FILE) ($(numfmt --to=iec $node_size))"
          echo "  â€¢ Bundled DLLs: $bundled_count"
          echo "  â€¢ Total size: $(numfmt --to=iec $total_size)"

      # 12. ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt-${{ matrix.os == 'ubuntu-24.04-arm' && 'linux' || (matrix.os == 'ubuntu-latest' && 'linux' || (startsWith(matrix.os, 'macos') && 'darwin' || 'win32')) }}-${{ matrix.arch }}
          path: prebuilds/
          retention-days: 30
          if-no-files-found: error

      # 13. ä¸Šä¼ å®Œæ•´æž„å»ºç›®å½•ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
      - name: Upload build directory for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-${{ matrix.os == 'ubuntu-24.04-arm' && 'linux' || (matrix.os == 'ubuntu-latest' && 'linux' || (startsWith(matrix.os, 'macos') && 'darwin' || 'win32')) }}-${{ matrix.arch }}
          path: |
            build/
            CMakeCache.txt
            cmake_install.cmake
          retention-days: 7

  # æ±‡æ€»æ‰€æœ‰æž„å»ºäº§ç‰©
  collect-artifacts:
    name: Collect All Artifacts
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          mkdir -p final-prebuilds
          
          # åˆå¹¶æ‰€æœ‰é¢„æž„å»ºæ–‡ä»¶
          echo "ðŸ“ å¯ç”¨çš„æž„å»ºäº§ç‰©ç›®å½•:"
          ls -la all-artifacts/ || echo "No artifacts directory"
          
          for artifact_dir in all-artifacts/prebuilt-*; do
            if [ -d "$artifact_dir" ]; then
              echo "ðŸ“¦ å¤„ç† $artifact_dir"
              # æ˜¾ç¤ºç›®å½•å†…å®¹ä»¥ä¾¿è°ƒè¯•
              echo "   å†…å®¹:"
              ls -la "$artifact_dir"
              cp -r "$artifact_dir"/* final-prebuilds/
            fi
          done
          
          echo ""
          echo "ðŸ“‹ åˆå¹¶åŽçš„final-prebuildsç›®å½•ç»“æž„:"
          find final-prebuilds -type f | sort
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æžœ
          echo "æ‰€æœ‰å¹³å°çš„æž„å»ºäº§ç‰©:"
          find final-prebuilds -name "*.node" -exec ls -la {} \;
          
          # æ±‡æ€»æž„å»ºä¿¡æ¯
          echo "# æž„å»ºæ‘˜è¦" > build-summary.md
          echo "æž„å»ºæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> build-summary.md
          echo "" >> build-summary.md
          echo "## æ”¯æŒçš„å¹³å°:" >> build-summary.md
          
          for info_file in final-prebuilds/*/build-info.json; do
            if [ -f "$info_file" ]; then
              platform=$(jq -r '.platform' "$info_file")
              arch=$(jq -r '.arch' "$info_file")
              file_size=$(jq -r '.file_size' "$info_file")
              echo "- $platform-$arch ($(numfmt --to=iec $file_size 2>/dev/null || echo $file_size))" >> build-summary.md
            fi
          done
          
          echo "" >> build-summary.md
          echo "## æ–‡ä»¶è¯¦æƒ…:" >> build-summary.md
          find final-prebuilds -name "*.node" | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "unknown")
            size_human=$(numfmt --to=iec $size 2>/dev/null || echo "$size bytes")
            echo "- \`$(basename "$file")\`: $size_human" >> build-summary.md
          done

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-prebuilds
          path: |
            final-prebuilds/
            build-summary.md
          retention-days: 90
